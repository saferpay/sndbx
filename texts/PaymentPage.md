# Payment Page

The [Saferpay Payment Page](https://saferpay.github.io/jsonapi/#ChapterPaymentPage) can be used both with a Saferpay eCommerce contract and with a Saferpay business contract. It allows the processing of all payment methods available through Saferpay. Once integrated, more payment methods can also be activated at any time and without major adjustments.

## Description of the General Process for Using PaymentPage

### PaymentPage Initialize

The process begins with the [PaymentPage Initialize](https://saferpay.github.io/jsonapi/#Payment_v1_PaymentPage_Initialize) request. When this is loaded, all data necessary for the payment are forwarded to Saferpay.  These include the customer number (CustomerId), the terminal number (Terminal Id), the currency (CurrencyCode), the amount (Value), the internal reference no. of the merchant system (OrderId), and the return addresses (ReturnUrls) to which the customer is returned after leaving the payment page.

## Information on the Use and Significance of the Available Parameters

### PaymentMethods

By default, the payment page will always show all payment methods approved for the terminal in question. Limiting the display to a single item or preselection of the payment methods in the shop can be achieved via the **PaymentMethods** parameter. When using this parameter, the only payment methods displayed are those whose values are forwarded.  When forwarding multiple values, the PaymentPage opens with a page which offers the option to select the appropriate payment method. If only one value is passed, the PaymentPage skips the selection window. Invalid values or values from payment methods which are not available on the terminal or not available with the specified currency are ignored by the PaymentPage. For example, if only one value is forwarded and this is invalid, the Payment Page will display the same options as if **PaymentMethods** had not been used.

### ReturnUrls

Via the **ReturnUrls**, the customer is returned to the shop after the transaction. For security reasons, Saferpay provides no information on the transaction when doing this. The identification of the payment and/or the return customers is up to the merchant. We recommend using your own parameters (session ID or other unique values) that can be attached via HTTP GET to the **ReturnUrls**.  The parameters returned allow the corresponding assignment on the shop side. 

### NotifyUrl 

Although it is entirely optional, we strongly recommend integrating the **NotifyUrl**(see **Notification** container).
With **NotifyUrl**, notification of the shop in the event of a successful payment is made regardless of connection problems that may prevent the customer getting back to the shop.   Without **NotifyUrl**, such an authorisation would be present in Saferpay Backoffice, but the shop would however have received no feedback on this. Looked at from a technical perspective, **NotifyUrl** notifies the merchant system in addition to the notification from Success URL. In contrast to Success URL, **NotifyUrl** is called up directly via HTTP GET Saferpay upon successful payment. It should be remembered that the notification via **NotifyUrl** takes place in addition to the call-up of the Success URL. Moreover, Saferpay expects the merchant server to answer the call-up of the address with a HTTP status code 200(OK). If the status code is not received, Saferpay will be called up once or twice more in order to counter temporary timeouts and errors. 
It must therefore be ensured that any repeated response regarding the same transaction is processed correctly on the shop side.  

### BillingAddressForm and DeliveryAddressForm

The use of BillingAddressForm or DeliveryAddressForm allows customers to fill in a form during payment for the data capture of their address details. It can be freely decided which text entry boxes are mandatory to fill out and which are not. Upon completion of the payment, Saferpay returns the address in question via the [PaymentPage Assert](https://saferpay.github.io/jsonapi/#Payment_v1_PaymentPage_Assert) response.

### RegisterAlias 

The use of **RegisterAlias** allows customer card details to be tokenised for later use. The card details, including expiration date, are stored by Saferpay in a secure database and linked to a replacement value. The parameter **IdGenerator** is used to determine how the replacement value is generated. If **MANUAL** is specified, the shop system passes an absolutely unique value. With **RANDOM**, an random alphanumeric value is generated by Saferpay. With **RANDOM_UNIQUE**, it will be additionally verified prior to generation of the replacement value, as to whether or not the card number/expiration date combination already exists as an alias entry in the database. If so, the already existing replacement value is returned and nothing new is generated.
>
**Attention**: The registration and/or storage of the card details proceeds in each case only after authorisation, and even then only if this was successful. Moreover, the card details data can be tokenized with a PaymentPage transaction. However, transactions with the replacement card value thus generated are then only possible via the transaction interface.
>

## PaymentPage Initialize Response

### Token

The **Token** refers to the values temporarily stored regarding the Saferpay transaction and is mandatory during subsequent processing of the transaction ([for more information, see e.g. **PaymentPage Assert**](http://saferpay.github.io/jsonapi/index.html#Payment_v1_PaymentPage_Assert)). The Token should be coupled to the http-GET parameters that were previously attached to the **ReturnUrls** and **NotifyUr**l for identification. 

### RedirectUrl

**RedirectURL** provides the address via which the buyer is redirected to the PaymentPage. This can be done automatically via calling up the Iframe or by embedding the URL in an HTML link that must be clicked on by the buyer.

## Transaction

The transaction will be fully processed by the PaymentPage. The Payment Page handles all steps automatically, including [3D Secure](https://saferpay.github.io/sndbx/index.html#3ds) and [DCC](https://saferpay.github.io/sndbx/index.html#dcc). No additional steps are necessary on the merchant website.

## Return to the Shop

When the transaction is complete, the buyer – depending on the result – is returned to one of the **ReturnUrls** in the shop. Via the URL parameters previously attached by way of http-GET, mapping to the corresponding token can take place and the next step be started.

## PaymentPage Assert

With [**PaymentPage Assert**](https://saferpay.github.io/jsonapi/#Payment_v1_PaymentPage_Assert), the results of a transaction are displayed. The returned data may be stored on the merchant side.

Based on the data obtained, it is to be decided whether or not a transaction is to be further processed. The following data is interesting in this regard:

+ **Transaction > ID:**
The transaction identifier returned in the container **Transaction** with **Id** is a unique identifier for a transaction. The value is obligatory for further processing steps (Transaction Capture or Transaction Cancel) and should therefore be saved.

+ **ThreeDs:**
This container provides information about whether or not transaction liability shift via [3D Secure](https://saferpay.github.io/sndbx/index.html#3ds) is present. It is up to merchants whether or not they want to accept transactions without liability shift. Evaluation of the parameter provides the opportunity for merchants to incorporate appropriate rules here. 

+ **Transaction > Status:** 
As already described [here](https://saferpay.github.io/sndbx/General.html#capture-batch), this status states whether or not a transaction has to be finalised via [Capture](https://saferpay.github.io/jsonapi/#Payment_v1_Transaction_Capture). If this status is not **CAPTURED**, the capture must be run in order to finalise the transaction.

## Capture oder Cancel

Subsequently, the transaction will be finalised via [**Capture**](https://saferpay.github.io/jsonapi/#Payment_v1_Transaction_Capture) or broken off via [**Cancel**](https://saferpay.github.io/jsonapi/#Payment_v1_Transaction_Cancel).For this, the transaction identifier **Id** is required. Please refer to the notes on the payment methods on if and when a **Capture** is necessary, and whether a **Cancel** can still be carried out.

Once these steps are complete, the transaction is completed.

